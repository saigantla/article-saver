<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVR // Article Archive</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXJ0aWNsZSBBcmNoaXZlIiwic2hvcnRfbmFtZSI6IlNWUiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGYwZjEyIiwidGhlbWVfY29sb3IiOiIjMDBmM2ZmIn0=">
    <meta name="theme-color" content="#0f0f12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        obsidian: '#0f0f12',
                        cardbg: '#16161a',
                        cyan: '#00f3ff',
                        dim: '#888890',
                        border: '#2a2a30',
                        reader: '#e0e0e0',
                        sidebar: '#121215'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        serif: ['Merriweather', 'serif']
                    },
                    boxShadow: {
                        'neon': '0 0 5px rgba(0, 243, 255, 0.2), 0 0 10px rgba(0, 243, 255, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f12; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f3ff; }

        /* Reading Progress Bar */
        #progress-bar { transition: width 0.1s ease; }

        /* Smooth Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography for Reader */
        .prose-custom p { margin-bottom: 1.8em; line-height: 1.9; color: #d4d4d8; font-size: 1.125rem; }
        .prose-custom h3 { color: #fff; font-weight: 700; margin-top: 2.5em; margin-bottom: 1em; font-size: 1.5em; letter-spacing: -0.02em; font-family: 'Inter', sans-serif; }
        .prose-custom blockquote { border-left: 3px solid #00f3ff; padding-left: 1.5rem; margin: 2rem 0; font-style: italic; color: #a1a1aa; font-size: 1.2rem; background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 0 4px 4px 0; }
        .prose-custom ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.5rem; color: #d4d4d8; }
        .prose-custom li { margin-bottom: 0.5rem; }

        /* Loading Spinner */
        .loader { border: 2px solid #333; border-top: 2px solid #00f3ff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tag Styling */
        .tag-pill { display: inline-flex; align-items: center; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; background: rgba(0, 243, 255, 0.05); border: 1px solid rgba(0, 243, 255, 0.2); color: #00f3ff; margin-right: 0.5rem; transition: all 0.2s ease; }

        /* Drag & Drop Visuals */
        .article-card[draggable="true"] { cursor: grab; }
        .article-card.dragging { opacity: 0.4; border-color: #00f3ff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); transform: scale(0.98); }
        .drop-target { border-color: #00f3ff !important; background-color: rgba(0, 243, 255, 0.1) !important; box-shadow: inset 0 0 10px rgba(0, 243, 255, 0.2); }
        
        /* Sidebar Item Styling */
        .sidebar-item { transition: all 0.2s; border-left: 2px solid transparent; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(255,255,255,0.03); color: white; }
        .sidebar-item.active { border-left-color: #00f3ff; color: #00f3ff; }
        .sidebar-item.drop-target { background: rgba(0, 243, 255, 0.15); color: #00f3ff; border-left-color: #00f3ff; }
        
        /* Checkbox for Selection Mode */
        .custom-checkbox {
            appearance: none;
            background-color: #1a1a1e;
            border: 1px solid #333;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.75rem;
            height: 0.75rem;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #00f3ff;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox.checked::before {
            transform: scale(1);
        }
        .custom-checkbox.checked {
            border-color: #00f3ff;
        }
    </style>
</head>
<body class="bg-obsidian text-gray-300 min-h-screen font-sans antialiased selection:bg-cyan selection:text-black overflow-x-hidden flex flex-col">

    <!-- GLOBAL HEADER -->
    <header class="fixed top-0 w-full bg-obsidian/90 backdrop-blur-md border-b border-border z-40 h-16 flex items-center justify-between px-6 lg:px-8">
        <div class="flex items-center space-x-3 group cursor-pointer" onclick="app.goHome()">
            <div class="w-2 h-6 bg-cyan group-hover:shadow-neon transition-shadow"></div>
            <h1 class="font-mono font-bold text-lg tracking-widest text-white">SVR<span class="text-dim text-sm font-normal ml-2 hidden sm:inline">// ARCHIVE_NODE</span></h1>
        </div>

        <div class="flex items-center space-x-6">
            <button onclick="app.refreshData()" class="text-dim hover:text-cyan transition-colors" title="Refresh Data">
                <i id="refresh-icon" class="fa-solid fa-arrows-rotate"></i>
            </button>
            <div class="flex items-center space-x-2">
                <div id="status-indicator" class="w-2 h-2 rounded-full" title="Checking..."></div>
                <span id="status-text" class="font-mono text-xs text-dim hidden sm:inline"></span>
            </div>
            <button onclick="app.openBookmarkletModal()" class="flex items-center space-x-2 border border-border px-4 py-1.5 rounded hover:border-cyan hover:text-cyan transition-colors text-sm font-mono group">
                <i class="fa-solid fa-bookmark text-xs"></i>
                <span>BOOKMARKLET</span>
            </button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="pt-16 min-h-screen flex max-w-[1600px] mx-auto w-full">
        
        <!-- SIDEBAR (Navigation & Groups) -->
        <aside id="sidebar-panel" class="w-64 fixed lg:static top-16 bottom-0 left-0 bg-sidebar border-r border-border p-4 overflow-y-auto hidden lg:block z-30 transform transition-transform duration-300 -translate-x-full lg:translate-x-0">
            
            <div class="mb-8">
                <h3 class="font-mono text-[10px] text-dim mb-2 tracking-wider">LIBRARY</h3>
                <nav class="space-y-1">
                    <button onclick="app.setFilter('status', 'all')" class="sidebar-item w-full text-left px-3 py-2 text-sm font-mono text-dim rounded flex justify-between items-center group active" data-val="all">
                        <span>ALL DATA</span>
                        <span id="count-all" class="text-[10px] bg-obsidian px-1.5 py-0.5 rounded text-dim group-hover:text-white">0</span>
                    </button>
                    <button onclick="app.setFilter('status', 'unread')" class="sidebar-item w-full text-left px-3 py-2 text-sm font-mono text-dim rounded flex justify-between items-center group" data-val="unread">
                        <span>UNREAD</span>
                        <span id="count-unread" class="text-[10px] bg-obsidian px-1.5 py-0.5 rounded text-dim group-hover:text-white">0</span>
                    </button>
                    <button onclick="app.setFilter('status', 'read')" class="sidebar-item w-full text-left px-3 py-2 text-sm font-mono text-dim rounded flex justify-between items-center group" data-val="read">
                        <span>READ</span>
                        <span id="count-read" class="text-[10px] bg-obsidian px-1.5 py-0.5 rounded text-dim group-hover:text-white">0</span>
                    </button>
                </nav>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="font-mono text-[10px] text-dim tracking-wider">RESEARCH GROUPS</h3>
                    <button onclick="app.createNewGroup()" class="text-xs text-dim hover:text-cyan" title="New Group">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                
                <div id="group-list" class="space-y-1">
                    <!-- Groups Injected Here -->
                    <div class="text-center py-4 text-dim text-xs italic">Loading...</div>
                </div>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 px-4 lg:px-8 py-8 w-full">
            
            <!-- VIEW: LIBRARY -->
            <section id="view-library" class="fade-in block h-full">
                
                <!-- Tools Bar -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    
                    <div class="flex items-center w-full md:w-auto space-x-4">
                        <!-- Mobile Menu Toggle -->
                        <button class="lg:hidden text-dim hover:text-white" onclick="document.getElementById('sidebar-panel').classList.toggle('-translate-x-full')">
                            <i class="fa-solid fa-bars"></i>
                        </button>

                        <!-- Selection Mode Toggle -->
                        <button onclick="app.toggleSelectionMode()" id="select-mode-btn" class="text-xs font-mono border border-border px-3 py-1.5 rounded text-dim hover:text-white hover:border-white transition-colors flex items-center space-x-2">
                            <i class="fa-regular fa-square-check"></i>
                            <span>SELECT</span>
                        </button>

                        <div id="selection-actions" class="hidden flex items-center space-x-2 animate-pulse">
                            <span class="text-xs font-mono text-cyan"><span id="selected-count">0</span> SELECTED</span>
                            <span class="text-[10px] text-dim hidden sm:inline">(DRAG TO GROUP)</span>
                        </div>
                    </div>

                    <!-- Search (Visual Only for now as requested by revert, kept simple) -->
                    <div class="font-mono text-xs text-dim">
                        <!-- Placeholder for future search if re-added -->
                    </div>
                </div>

                <!-- Article Grid -->
                <div id="article-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                    <div class="col-span-full flex flex-col items-center justify-center py-20 opacity-50">
                        <div class="loader mb-4"></div>
                        <p class="font-mono text-xs">INITIALIZING CONNECTION...</p>
                    </div>
                </div>
            </section>

            <!-- VIEW: READER -->
            <section id="view-reader" class="hidden fade-in max-w-3xl mx-auto">
                <!-- Reading Progress Bar -->
                <div class="fixed top-[64px] left-0 h-[2px] bg-cyan shadow-neon z-50 w-0" id="progress-bar"></div>

                <!-- Reader Nav & Controls -->
                <div class="flex justify-between items-center mb-8">
                    <button onclick="app.goHome()" class="group flex items-center space-x-2 text-dim hover:text-cyan font-mono text-xs transition-colors">
                        <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                        <span>RETURN TO GRID</span>
                    </button>

                    <!-- Parser Controls -->
                    <div class="flex items-center space-x-4">
                        <button onclick="app.redriveParsing()" title="Redrive Parsing" class="text-dim hover:text-cyan transition-colors">
                            <i id="redrive-icon" class="fa-solid fa-rotate-right text-xs"></i>
                        </button>
                        
                        <div class="relative group">
                            <button class="flex items-center space-x-2 font-mono text-xs text-dim hover:text-white border border-border rounded px-3 py-1">
                                <span id="current-parser-label">MODE: READABILITY</span>
                                <i class="fa-solid fa-chevron-down text-[10px]"></i>
                            </button>
                            <!-- Dropdown -->
                            <div class="absolute right-0 mt-1 w-48 bg-cardbg border border-border rounded shadow-xl hidden group-hover:block z-50">
                                <button onclick="app.setParser('readability')" class="block w-full text-left px-4 py-2 text-xs font-mono text-dim hover:text-cyan hover:bg-obsidian">READABILITY</button>
                                <button onclick="app.setParser('defuddle')" class="block w-full text-left px-4 py-2 text-xs font-mono text-dim hover:text-cyan hover:bg-obsidian">DEFUDDLE</button>
                                <button onclick="app.setParser('postlight')" class="block w-full text-left px-4 py-2 text-xs font-mono text-dim hover:text-cyan hover:bg-obsidian">POSTLIGHT</button>
                                <button onclick="app.setParser('llm')" class="block w-full text-left px-4 py-2 text-xs font-mono text-dim hover:text-cyan hover:bg-obsidian">LLM</button>
                                <button onclick="app.setParser('original')" class="block w-full text-left px-4 py-2 text-xs font-mono text-dim hover:text-cyan hover:bg-obsidian">RAW HTML</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Article Header -->
                <header class="mb-12 border-b border-border pb-8">
                    <div class="flex flex-wrap items-center gap-3 mb-4 font-mono text-xs text-dim tracking-wider uppercase">
                        <span id="reader-source" class="text-cyan">SOURCE</span>
                        <span>//</span>
                        <span id="reader-author">AUTHOR</span>
                        <span class="mx-2">|</span>
                        <span id="reader-date">DATE</span>
                    </div>
                    
                    <h1 id="reader-title" class="text-3xl md:text-5xl font-bold text-white leading-tight mb-6 font-sans">
                        Article Title
                    </h1>

                    <div class="flex items-center space-x-3 font-mono text-xs text-dim">
                        <span class="bg-cardbg px-2 py-1 rounded border border-border" id="reader-time">5m READ</span>
                        <div id="reader-tags" class="flex items-center">
                            <!-- Tags injected here -->
                        </div>
                    </div>
                </header>

                <!-- Article Content -->
                <div class="relative min-h-[200px]">
                    <article id="reader-content" class="prose-custom text-lg font-serif">
                        <!-- Content injected here -->
                    </article>
                </div>

                <!-- Reader Footer -->
                <div class="mt-16 pt-8 border-t border-border flex justify-between items-center">
                    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="text-dim hover:text-white font-mono text-xs">
                        [ SCROLL TO TOP ]
                    </button>
                    <div class="flex space-x-4">
                        <button class="text-dim hover:text-cyan font-mono text-xs" id="reader-mark-read">MARK READ</button>
                        <button onclick="app.deleteCurrent()" class="text-dim hover:text-red-500 font-mono text-xs">DELETE</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL: BOOKMARKLET -->
    <div id="modal-bookmarklet" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- Bookmarklet content same as before -->
        <div class="bg-cardbg border border-border w-full max-w-2xl p-6 rounded shadow-2xl relative">
            <button onclick="app.closeBookmarkletModal()" class="absolute top-4 right-4 text-dim hover:text-white">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h2 class="font-mono text-lg text-white mb-6 flex items-center">
                <i class="fa-solid fa-bookmark mr-3 text-cyan"></i> ARTICLE SAVER BOOKMARKLET
            </h2>
            <div class="space-y-4 text-sm text-gray-300">
                <p>Drag this button to your bookmarks bar:</p>
                <div class="flex justify-center my-6">
                    <a href="" id="bookmarklet-link" class="inline-block bg-cyan/10 text-cyan px-6 py-3 rounded border border-cyan hover:bg-cyan hover:text-black transition-all font-mono cursor-move">
                        ðŸ’¾ Save Article
                    </a>
                </div>
                <p class="text-xs text-dim">Use this to save articles from other tabs.</p>
            </div>
        </div>
    </div>

    <!-- IndexedDB Wrapper -->
    <script src="/db.js"></script>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const API_BASE = window.location.origin;

        const state = {
            articles: [],
            currentArticleId: null,
            currentParserMode: 'readability',
            filters: {
                status: 'all',
                topic: 'all'
            },
            reprocessTriggered: new Set(),
            customGroups: [],
            draggingIds: [],
            selectionMode: false,
            selectedIds: new Set()
        };

        const els = {
            sidebar: document.getElementById('sidebar-panel'),
            libraryView: document.getElementById('view-library'),
            readerView: document.getElementById('view-reader'),
            articleList: document.getElementById('article-list'),
            groupList: document.getElementById('group-list'),
            bookmarkletModal: document.getElementById('modal-bookmarklet'),
            statusIndicator: document.getElementById('status-indicator'),
            progressBar: document.getElementById('progress-bar'),
            refreshIcon: document.getElementById('refresh-icon'),
            redriveIcon: document.getElementById('redrive-icon'),
            currentParserLabel: document.getElementById('current-parser-label'),
            // Selection
            selectBtn: document.getElementById('select-mode-btn'),
            selectionActions: document.getElementById('selection-actions'),
            selectedCount: document.getElementById('selected-count'),
            // Counters
            countAll: document.getElementById('count-all'),
            countUnread: document.getElementById('count-unread'),
            countRead: document.getElementById('count-read'),
            // Reader
            rTitle: document.getElementById('reader-title'),
            rSource: document.getElementById('reader-source'),
            rAuthor: document.getElementById('reader-author'),
            rDate: document.getElementById('reader-date'),
            rTime: document.getElementById('reader-time'),
            rContent: document.getElementById('reader-content'),
            rTags: document.getElementById('reader-tags'),
            rMarkRead: document.getElementById('reader-mark-read')
        };

        const utils = {
            formatDate: (timestamp) => {
                if (!timestamp) return 'UNKNOWN';
                const date = new Date(timestamp);
                return date.toISOString().split('T')[0];
            },
            safeHostname: (urlStr) => {
                if(!urlStr) return 'UNKNOWN';
                try { return new URL(urlStr).hostname.replace('www.', ''); } catch (e) { return 'SOURCE'; }
            }
        };

        window.app = {
            init: async () => {
                if (typeof db !== 'undefined' && db.init) {
                    await db.init();
                } else {
                    console.error("IndexedDB wrapper 'db' is missing!");
                }

                const isOnline = await app.checkConnection();
                if (isOnline) {
                    await app.loadArticles();
                } else {
                    await app.loadArticlesFromCache();
                }
                
                // SW Setup
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').catch(e => console.error(e));
                }
                
                window.addEventListener('scroll', () => {
                    if (els.readerView.classList.contains('hidden')) return;
                    const scrollTop = window.scrollY;
                    const docHeight = document.body.offsetHeight - window.innerHeight;
                    const scrollPercent = (scrollTop / docHeight) * 100;
                    els.progressBar.style.width = Math.min(100, Math.max(0, scrollPercent)) + '%';
                });

                app.generateBookmarklet();
            },

            checkConnection: async () => {
                try {
                    const response = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(3000) });
                    return response.ok;
                } catch { return false; }
            },

            updateConnectionStatus: (isOnline) => {
                if (isOnline) {
                    els.statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]';
                    els.statusIndicator.title = "Online";
                    document.getElementById('status-text').textContent = "ONLINE";
                } else {
                    els.statusIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_10px_#fbbf24]';
                    els.statusIndicator.title = "Offline";
                    document.getElementById('status-text').textContent = "OFFLINE";
                }
            },

            loadArticlesFromCache: async () => {
                if (typeof db !== 'undefined') {
                    state.articles = await db.getAllArticles();
                    app.renderLibrary();
                    app.renderGroupList();
                }
            },

            loadArticles: async () => {
                try {
                    const response = await fetch(`${API_BASE}/articles`, { signal: AbortSignal.timeout(5000) });
                    const articles = await response.json();
                    if (typeof db !== 'undefined') {
                        await db.saveArticles(articles);
                    }
                    state.articles = articles;
                    app.updateConnectionStatus(true);
                    app.renderLibrary();
                    app.renderGroupList();
                } catch (error) {
                    console.warn("Network failed, cache fallback", error);
                    app.updateConnectionStatus(false);
                    await app.loadArticlesFromCache();
                }
            },
            
            refreshData: () => {
                if(els.refreshIcon) els.refreshIcon.classList.add('fa-spin');
                app.loadArticles();
                setTimeout(() => { if(els.refreshIcon) els.refreshIcon.classList.remove('fa-spin'); }, 800);
            },

            // --- SELECTION ---

            toggleSelectionMode: () => {
                state.selectionMode = !state.selectionMode;
                state.selectedIds.clear();
                
                if(state.selectionMode) {
                    els.selectBtn.classList.add('bg-cyan/10', 'border-cyan', 'text-cyan');
                    els.selectionActions.classList.remove('hidden');
                } else {
                    els.selectBtn.classList.remove('bg-cyan/10', 'border-cyan', 'text-cyan');
                    els.selectionActions.classList.add('hidden');
                }
                app.renderLibrary();
                app.updateSelectedCount();
            },

            toggleSelectArticle: (id, e) => {
                e.stopPropagation();
                if(state.selectedIds.has(id)) {
                    state.selectedIds.delete(id);
                } else {
                    state.selectedIds.add(id);
                }
                app.renderLibrary();
                app.updateSelectedCount();
            },

            updateSelectedCount: () => {
                els.selectedCount.textContent = state.selectedIds.size;
            },

            // --- FILTER & GROUP LOGIC ---

            setFilter: (type, val) => {
                if(type === 'status') {
                    state.filters.topic = 'all'; 
                    state.filters.status = val;
                } else if (type === 'topic') {
                    state.filters.status = 'all';
                    state.filters.topic = val;
                }

                document.querySelectorAll('.sidebar-item').forEach(el => {
                    if(el.dataset.val === val || (type === 'topic' && el.dataset.topic === val)) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });
                
                // Close sidebar on mobile
                if(window.innerWidth < 1024) {
                    els.sidebar.classList.add('-translate-x-full');
                }

                app.renderLibrary();
            },

            getFilteredArticles: () => {
                return state.articles.filter(a => {
                    if (state.filters.status === 'read' && a.status !== 'read') return false;
                    if (state.filters.status === 'unread' && a.status === 'read') return false;
                    
                    if (state.filters.topic !== 'all') {
                        const topics = a.topics || [];
                        if (!topics.includes(state.filters.topic)) return false;
                    }
                    return true;
                });
            },

            createNewGroup: () => {
                const name = prompt("Enter new Group Name:");
                if(!name) return;
                const cleanName = name.trim().toLowerCase();
                if(!state.customGroups.includes(cleanName)) {
                    state.customGroups.push(cleanName);
                }
                app.renderGroupList();
            },

            renderGroupList: () => {
                const allTopics = new Set(state.customGroups);
                state.articles.forEach(a => (a.topics||[]).forEach(t => allTopics.add(t)));
                const sortedTopics = Array.from(allTopics).sort();

                let html = '';
                sortedTopics.forEach(t => {
                    const count = state.articles.filter(a => (a.topics||[]).includes(t)).length;
                    const isActive = state.filters.topic === t;
                    html += `
                        <button 
                            onclick="app.setFilter('topic', '${t}')"
                            ondragover="app.handleDragOver(event)"
                            ondrop="app.handleDropOnGroup(event, '${t}')"
                            ondragleave="app.handleDragLeave(event)"
                            class="sidebar-item w-full text-left px-3 py-2 text-sm font-mono text-dim rounded flex justify-between items-center group ${isActive ? 'active' : ''}"
                            data-topic="${t}"
                        >
                            <span class="truncate pr-2"># ${t.toUpperCase()}</span>
                            <span class="text-[10px] bg-obsidian px-1.5 py-0.5 rounded text-dim group-hover:text-white">${count}</span>
                        </button>
                    `;
                });
                els.groupList.innerHTML = html || `<div class="text-center py-4 text-dim text-xs italic">No groups yet.</div>`;
                
                // Update Counts
                els.countAll.textContent = state.articles.length;
                els.countUnread.textContent = state.articles.filter(a => a.status !== 'read').length;
                els.countRead.textContent = state.articles.filter(a => a.status === 'read').length;
            },

            // --- DRAG & DROP ---

            handleDragStart: (e, id) => {
                // If dragging a selected item, we drag ALL selected items
                if(state.selectionMode && state.selectedIds.has(id)) {
                    state.draggingIds = Array.from(state.selectedIds);
                    e.dataTransfer.setData('text/plain', `${state.draggingIds.length} items`);
                } else {
                    // Dragging a single unselected item
                    state.draggingIds = [id];
                    e.dataTransfer.setData('text/plain', '1 item');
                }

                e.dataTransfer.effectAllowed = 'copyMove';
                setTimeout(() => {
                    // Visually dim all dragged items
                    state.draggingIds.forEach(dId => {
                        const card = document.getElementById(`card-${dId}`);
                        if(card) card.classList.add('dragging');
                    });
                }, 0);
            },

            handleDragEnd: (e) => {
                state.draggingIds.forEach(id => {
                    const card = document.getElementById(`card-${id}`);
                    if(card) card.classList.remove('dragging');
                });
                state.draggingIds = [];
                document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            },

            handleDragOver: (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('drop-target');
            },

            handleDragLeave: (e) => {
                e.currentTarget.classList.remove('drop-target');
            },

            handleDropOnGroup: async (e, topic) => {
                e.preventDefault();
                e.currentTarget.classList.remove('drop-target');
                
                const ids = state.draggingIds;
                if(ids.length === 0) return;

                // Optimistic & Backend Update for ALL items
                const promises = ids.map(async (id) => {
                    const article = state.articles.find(a => a.id === id);
                    if(!article) return;

                    let newTopics = article.topics || [];
                    if(!newTopics.includes(topic)) {
                        newTopics.push(topic);
                        article.topics = newTopics; // Optimistic
                        
                        return fetch(`${API_BASE}/articles/${id}`, {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ topics: newTopics })
                        });
                    }
                });

                try {
                    await Promise.all(promises);
                    app.renderLibrary();
                    app.renderGroupList();
                    
                    // Optional: Clear selection after drop?
                    // state.selectedIds.clear();
                    // app.toggleSelectionMode();
                } catch(err) { console.error("Failed to update topics", err); }
            },

            // --- RENDER ---

            renderLibrary: () => {
                const filtered = app.getFilteredArticles();
                els.articleList.innerHTML = '';

                if (filtered.length === 0) {
                    els.articleList.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-20 border border-dashed border-border rounded text-dim">
                            <p class="font-mono text-sm mb-4">NO ARTICLES FOUND</p>
                        </div>
                    `;
                    return;
                }

                filtered.forEach(article => {
                    const isRead = article.status === 'read';
                    const isSelected = state.selectedIds.has(article.id);
                    
                    const card = document.createElement('article');
                    card.id = `card-${article.id}`;
                    card.setAttribute('draggable', 'true');
                    card.ondragstart = (e) => app.handleDragStart(e, article.id);
                    card.ondragend = (e) => app.handleDragEnd(e);
                    
                    card.className = `article-card group relative bg-cardbg border ${isSelected ? 'border-cyan' : 'border-border'} rounded p-5 transition-all duration-200 hover:shadow-neon cursor-grab flex flex-col h-full ${isRead ? 'opacity-60 hover:opacity-100' : ''}`;
                    
                    const tags = (article.topics || []).map(t => `<span class="text-[10px] text-cyan mr-2">#${t}</span>`).join('');

                    card.innerHTML = `
                        <!-- Selection Checkbox -->
                        <div class="absolute top-4 right-4 z-10 ${state.selectionMode ? 'block' : 'hidden'}">
                            <div class="custom-checkbox ${isSelected ? 'checked' : ''}" onclick="app.toggleSelectArticle(${article.id}, event)"></div>
                            ${isSelected ? '<i class="fa-solid fa-check text-[10px] text-cyan absolute inset-0 m-auto pointer-events-none"></i>' : ''}
                        </div>

                        <div class="flex justify-between items-start mb-2 pointer-events-none">
                            <h2 class="text-lg font-semibold text-gray-100 group-hover:text-white transition-colors leading-tight pr-8 line-clamp-2">
                                ${article.title}
                            </h2>
                        </div>
                        <div class="flex items-center space-x-2 mb-2 font-mono text-[10px] text-dim tracking-wider uppercase pointer-events-none">
                            <span class="text-cyan truncate max-w-[100px]">${utils.safeHostname(article.source || article.archive_url)}</span>
                            <span class="text-dim">|</span>
                            <span class="font-bold">${article.readTime || '3m'}</span>
                        </div>
                        <div class="mb-4 font-mono pointer-events-none">${tags}</div>
                        <div class="relative flex-grow pointer-events-none">
                             <p class="text-sm text-gray-400 leading-relaxed mb-6 line-clamp-3 border-l-2 border-transparent group-hover:border-cyan pl-0 group-hover:pl-3 transition-all duration-300">
                                ${article.snippet || "No preview."}
                            </p>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-border group-hover:border-gray-800 transition-colors mt-auto">
                            <div class="font-mono text-[10px] text-dim flex items-center pointer-events-none">
                                ${isRead ? '<i class="fa-solid fa-check mr-2 text-green-500"></i>' : ''}
                                ${utils.formatDate(article.captured_at)}
                            </div>
                            <div class="flex space-x-3 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <button onclick="event.stopPropagation(); app.toggleReadStatus(${article.id}, ${!isRead})" class="text-xs font-mono text-dim hover:text-white flex items-center transition-colors">
                                    <i class="fa-${isRead ? 'regular' : 'solid'} fa-circle-check"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.openReader(${article.id})" class="text-xs font-mono font-bold text-dim hover:text-cyan flex items-center transition-colors">
                                    [ READ ]
                                </button>
                                <button onclick="event.stopPropagation(); app.deleteArticle(${article.id})" class="text-xs font-mono text-dim hover:text-red-400 flex items-center transition-colors">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    card.onclick = (e) => {
                        if(state.selectionMode) {
                            app.toggleSelectArticle(article.id, e);
                        } else {
                            app.openReader(article.id);
                        }
                    };
                    els.articleList.appendChild(card);
                });
            },

            openReader: async (id) => {
                try {
                    const response = await fetch(`${API_BASE}/articles/${id}`);
                    if (!response.ok) throw new Error("Failed to fetch article");
                    
                    const article = await response.json();
                    
                    if (typeof db !== 'undefined') {
                        try { await db.saveArticle(article); } 
                        catch(e) { console.warn("Failed to cache article", e); }
                    }

                    state.currentArticleId = id;
                    state.parserResults = article.parser_results || {};
                    if(state.reprocessTriggered) state.reprocessTriggered.clear();

                    els.rTitle.textContent = article.title;
                    els.rSource.textContent = utils.safeHostname(article.source || article.archive_url);
                    els.rAuthor.textContent = article.author || 'UNKNOWN';
                    els.rDate.textContent = utils.formatDate(article.captured_at);
                    els.rTime.textContent = (article.readTime || '5m') + ' READ';
                    els.rContent.innerHTML = article.content || "<p>Content loading error.</p>";
                    els.rTags.innerHTML = (article.topics || []).map(t => `<span class="tag-pill ml-2">${t.toUpperCase()}</span>`).join('');
                    
                    const isRead = article.status === 'read';
                    els.rMarkRead.textContent = isRead ? "MARK UNREAD" : "MARK READ";
                    els.rMarkRead.onclick = () => app.toggleReadStatus(id, !isRead);

                    app.setParser('readability');
                    els.libraryView.classList.add('hidden');
                    els.readerView.classList.remove('hidden');
                    els.sidebar.classList.add('hidden');
                    window.scrollTo(0, 0);
                } catch (error) { 
                    console.error(error); 
                    alert("Error opening article: " + error.message);
                }
            },

            goHome: () => {
                els.readerView.classList.add('hidden');
                els.libraryView.classList.remove('hidden');
                els.sidebar.classList.remove('hidden');
                state.currentArticleId = null;
                els.progressBar.style.width = '0%';
            },

            toggleReadStatus: async (id, markAsRead) => {
                const status = markAsRead ? 'read' : 'unread';
                
                // Optimistic Update
                const article = state.articles.find(a => a.id === id);
                if(article) {
                    article.status = status;
                    app.renderLibrary();
                    app.renderGroupList(); // Update counts
                    
                    if(state.currentArticleId === id) {
                        els.rMarkRead.textContent = markAsRead ? "MARK UNREAD" : "MARK READ";
                        els.rMarkRead.onclick = () => app.toggleReadStatus(id, !markAsRead);
                    }
                }

                try {
                    await fetch(`${API_BASE}/articles/${id}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status })
                    });
                } catch(e) { console.error("Status update failed", e); }
            },

            // --- PARSER LOGIC (Existing) ---
            setParser: async (mode) => {
                state.currentParserMode = mode;
                els.currentParserLabel.textContent = `MODE: ${mode.toUpperCase()}`;
                
                const id = state.currentArticleId;
                if(!id) return;

                if (mode === 'original') {
                    try {
                        const response = await fetch(`${API_BASE}/articles/${id}/html`);
                        const htmlText = await response.text();
                        els.rContent.innerHTML = `<iframe srcdoc="${htmlText.replace(/"/g, '&quot;')}" style="width:100%; min-height:800px; border:none; background:white;" sandbox="allow-same-origin"></iframe>`;
                    } catch (e) { els.rContent.innerHTML = "<p class='text-red-400'>Failed to load HTML.</p>"; }
                    return;
                }

                if (mode === 'llm') {
                    // Logic to handle LLM loading/polling...
                    // (Simplified for brevity, assuming existing logic fits)
                    const article = state.articles.find(a => a.id === id);
                    if(article && article.llm_content) els.rContent.innerHTML = article.llm_content;
                    else els.rContent.innerHTML = `<div class="text-center py-12">Loading AI content...</div>`;
                    return;
                }

                let parserResult = state.parserResults ? state.parserResults[mode] : null;
                if(parserResult && parserResult.success) {
                    els.rContent.innerHTML = parserResult.htmlContent;
                } else {
                    // Trigger redrive if missing logic
                    els.rContent.innerHTML = `<div class="text-center py-12 text-dim">Parser content not available.</div>`;
                }
            },

            redriveParsing: async () => {
                const id = state.currentArticleId;
                const mode = state.currentParserMode;
                if(els.redriveIcon) els.redriveIcon.classList.add('fa-spin');
                
                try {
                    await fetch(`${API_BASE}/articles/${id}/reprocess`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ parser: mode })
                    });
                    setTimeout(() => {
                        if(els.redriveIcon) els.redriveIcon.classList.remove('fa-spin');
                        // Ideally poll here, but for now just wait
                    }, 2000);
                } catch(e) { console.error(e); }
            },

            deleteArticle: async (id) => {
                if(!confirm("Delete article?")) return;
                try {
                    await fetch(`${API_BASE}/articles/${id}`, {method: 'DELETE'});
                    if (typeof db !== 'undefined') await db.deleteArticle(id);
                    state.articles = state.articles.filter(a => a.id !== id);
                    app.renderLibrary();
                    app.renderGroupList();
                } catch(e) { console.error(e); }
            },
            
            deleteCurrent: async () => { if(state.currentArticleId) { await app.deleteArticle(state.currentArticleId); app.goHome(); } },
            openBookmarkletModal: () => els.bookmarkletModal.classList.remove('hidden'),
            closeBookmarkletModal: () => els.bookmarkletModal.classList.add('hidden'),
            generateBookmarklet: () => {
                // (Bookmarklet logic from before)
                document.getElementById('bookmarklet-link').href = 'javascript:(function(){window.open("'+API_BASE+'/save?url="+encodeURIComponent(window.location.href))})();';
            }
        };

        app.init();
    </script>
</body>
</html>